;; nyacc/lang/c99/c99-07.test           -*- scheme -*-
;;
;; Copyright (C) 2022 Matthew Wette
;; 
;; Copying and distribution of this file, with or without modification,
;; are permitted in any medium without royalty provided the copyright
;; notice and this notice are preserved.  This file is offered as-is,
;; without any warranty.

;; misc bugs

(define-module (c99-03)
  #:use-module (nyacc lang c99 parser)
  #:use-module (nyacc lang c99 util)
  #:use-module (test-suite lib))

(define incs '("exam.d"))

(define (parse-string str)
  (with-input-from-string str
    (lambda ()
      (parse-c99 #:inc-dirs incs #:mode 'file #:inc-help c99-std-help))))

(define (parse-file file)
  (with-input-from-file file
    (lambda ()
      (parse-c99 #:inc-dirs incs #:mode 'file))))

(define ctr
  (let ((p (make-count-reporter))) (register-reporter (car p)) ((cadr p))))
(register-reporter full-reporter)

;; parser test
(with-test-prefix "nyacc/c99-07, fixed bugs"

  ;; parse with include file
  (pass-if "unterminated #if (bug #63283)"
    (not
     (catch 'c99-error
       (lambda ()
         (with-error-to-port (%make-void-port "w")
           (lambda ()
             (with-input-from-file "exam.d/ex22.c"
               (lambda () (parse-c99 #:inc-dirs incs #:mode 'code))))))
       (lambda args #f))))

  ;; typedef as ident
  (pass-if "typedef as ident (bug #67201)"
    (and
     (let* ((code "typedef struct S S; struct S { S* S; } s;"))
       (with-input-from-string code parse-c99))
     #t))

  (pass-if "typedef as ident in function arg" 
    (and
     (let* ((code "typedef int foo; int f(foo foo);"))
       (with-input-from-string code parse-c99))
     #t))
  (pass-if "typedef scope w/ enum" 
    (and
     (let* ((code "typedef enum foo { FOO } foo_t; foo_t x;"))
       (with-input-from-string code parse-c99))
     #t))
  
  ;; typedef as ident
  (pass-if "typedef in function"
    (and
     (let* ((code (string-append "typedef unsigned bar;"
                                 "float f2(int x) {"
                                 " typedef float bar;"
                                 " bar y = 1.0;"
                                 " return x + y;"
                                 " }")))
       (with-input-from-string code parse-c99))
     #t))

  )

;;(with-input-from-file "exam.d/ex22.c"
;;  (lambda () (parse-c99 #:inc-dirs incs #:mode 'code)))

(exit (if (positive? (assq-ref ctr 'fail)) 1 0))
;; --- last line ---
