;; nyacc/foreign/arch-info-01.test	-*- scheme -*-
;;
;; Copyright (C) 2024 Matthew Wette
;;
;; Copying and distribution of this file, with or without modification,
;; are permitted in any medium without royalty provided the copyright
;; notice and this notice are preserved.  This file is offered as-is,
;; without any warranty.

(define-module (arch-info-01)
  #:use-module (nyacc foreign arch-info)
  #:use-module ((srfi srfi-1) #:select(fold))
  #:use-module (system foreign)
  #:use-module (system foreign-library)
  #:use-module (test-suite lib))

(define ctr
  (let ((p (make-count-reporter))) (register-reporter (car p)) ((cadr p))))
(register-reporter full-reporter)

(define (sferr fmt . args) (apply simple-format (current-error-port) fmt args))
(use-modules (ice-9 pretty-print))
(define (pperr exp) (pretty-print exp (current-error-port)))

(define* (load-extension* lib init #:key search-path)
  (let* ((xlib (load-foreign-library lib #:search-path search-path))
         (xinit (pointer->procedure
                 void (foreign-library-pointer xlib init) (list))))
    (xinit)))

(define base-type-symbol-testers
  (filter
   (lambda (s) (not (member s '(long-double
                                _Float16 _Float128 float-_Complex
                                double-_Complex long-double-_Complex
                                __int128 unsigned-__int128
                                ;; deprecated
                                short-int signed-short
                                signed-short-int unsigned-short-int signed
                                signed-int unsigned-int long-int signed-long
                                signed-long-int unsigned-long-int long-long-int
                                signed-long-long signed-long-long-int
                                unsigned-long-long-int))))
   base-type-symbol-list))


;; compare arch to base
(use-modules ((srfi srfi-1)
              #:select (lset-difference fold)))
(define-public (cmp-arch arch-name base-name)
  (sferr "\ncmp-arch: ~s vs ~s\n" arch-name base-name)
  (let* ((arch (assq-ref (*arch-map*) arch-name))
         (base (assq-ref (*arch-map*) base-name))
         (atm (arch-mtype-map arch)) (akeys (map car atm))
         (btm (arch-mtype-map base)) (bkeys (map car btm))
         ;;
         (a-b-keys (lset-difference equal? akeys bkeys))
         (b-a-keys (lset-difference equal? bkeys akeys))
         (zzz (lambda (k s)
                (let ((av (assoc-ref atm k)) (bv (assoc-ref btm k)))
                  ;;(sferr "(eq? av bv) => (eq? ~s ~s)\n" av bv)
                  (cond
                   ((eq? av bv) s)
                   (else (sferr "missmatch on ~s: ~s vs ~s\n" k av bv) #f)))))
         (ab-comp (fold zzz #t akeys)))
    ;;(sferr "akeys: ~s\n" akeys)
    ;;(sferr "bkeys: ~s\n" bkeys)
    ;;(sferr "a-b-keys: ~s\n" a-b-keys)
    ;;(sferr "b-a-keys: ~s\n" b-a-keys)
    ;;(sferr "ab-comp: ~s\n" ab-comp)
    (cond
     ((pair? a-b-keys) (sferr "bkeys-akeys = ~s\n" a-b-keys) #f)
     ((pair? b-a-keys) (sferr "bkeys-akeys = ~s\n" b-a-keys) #f)
     ((not ab-comp) #f)
     (else #t))))

(with-test-prefix "nyacc/foreign/arch-info-01"

  (define chkarch-compiled
    (let* ((eff-vers (effective-version))
           (incdir (string-append (assq-ref %guile-build-info 'includedir)
                                  "/guile/" eff-vers))
           (libdir (assq-ref %guile-build-info 'libdir))
           (flags (format #f "-shared -fPIC -I~a" incdir))
           (libs (format #f "-L~a -lguile-~a" libdir eff-vers))
           (cstr (format #f "gcc -o chkarch.so chkarch.c ~a ~a" flags libs))
           (status (status:exit-val (system cstr))))
      (when (zero? status)
        (load-extension* "chkarch" "chkarch_init"
                         #:search-path (list (getcwd))))
      (zero? status)))

    (pass-if "scheme sizeof vs cc sizeof"
      (if chkarch-compiled
            (fold
             (lambda (n s)
               (let ((g-sz (sizeof-basetype n))
                     (n-sz (arch-sizeof n)))
                 (and s (= n-sz g-sz))))
             #t base-type-symbol-testers)
            'untested))

    (pass-if "scheme alignof vs cc __alignof__"
      (if chkarch-compiled
          (fold
           (lambda (n s)
             (let ((g-sz (sizeof-basetype n))
                   (n-sz (arch-sizeof n)))
               (and s (= n-sz g-sz))))
           #t base-type-symbol-testers)
          'untested))
  
    )

(exit (if (positive? (assq-ref ctr 'fail)) 1 0))

;; --- last line ---
